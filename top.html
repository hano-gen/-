<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>位置情報スタンプラリー</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .tab-button {
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .tab-button.active {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            border-bottom: 2px solid #4f46e5;
        }
        .tab-button:not(.active):hover {
            background-color: #e0e7ff; /* indigo-100 */
        }
        .content-section {
            display: none; /* Initially hide all sections */
        }
        .content-section.active {
            display: block;
        }
        .stamp {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .stamp:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .stamp-collected {
            background-color: #10b981; /* Tailwind emerald-500 */
            color: white;
        }
        .stamp-not-collected {
            background-color: #ffffff; /* White */
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 0.5rem;
            text-align: center;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-sky-100 to-indigo-200 min-h-screen flex flex-col items-center p-4">

    <div id="app-container" class="w-full max-w-3xl bg-white shadow-xl rounded-lg">
        <header class="bg-indigo-700 text-white p-6 rounded-t-lg">
            <h1 class="text-3xl md:text-4xl font-bold text-center">位置情報スタンプラリー</h1>
            <p id="user-id-display" class="text-xs text-indigo-200 mt-1 text-center"></p>
        </header>

        <!-- Tab Navigation -->
        <nav class="flex border-b border-gray-300 bg-gray-50">
            <button data-tab="home" class="tab-button flex-1 py-3 px-2 md:py-4 md:px-4 text-center font-medium text-gray-700 active">ホーム</button>
            <button data-tab="collect" class="tab-button flex-1 py-3 px-2 md:py-4 md:px-4 text-center font-medium text-gray-700">スタンプ獲得</button>
            <button data-tab="locations" class="tab-button flex-1 py-3 px-2 md:py-4 md:px-4 text-center font-medium text-gray-700">獲得可能場所</button>
        </nav>

        <div id="loading-indicator" class="text-center py-12">
            <div class="loader"></div>
            <p class="text-indigo-600 font-semibold">データを読み込み中...</p>
        </div>

        <div id="auth-message" class="hidden text-center py-12 px-6">
            <p class="text-red-600 font-semibold">認証情報がありません。アプリを正しく利用できません。</p>
        </div>
        
        <main id="app-main-content" class="p-6 md:p-8">
            <!-- Home Section -->
            <section id="home-content" class="content-section active">
                <h2 class="text-2xl font-semibold text-indigo-700 mb-4">ようこそ！</h2>
                <p class="text-gray-700 mb-6">
                    このアプリでは、指定された場所に近づいてスタンプを集めることができます。
                    「スタンプ獲得」タブで現在の位置情報を使ってスタンプを集め、「獲得可能場所」タブで各スポットの詳細を確認できます。
                </p>
                <div class="bg-indigo-50 p-4 rounded-lg shadow mb-6">
                    <h3 class="text-xl font-semibold text-indigo-700 mb-2">現在の獲得状況</h3>
                    <p id="home-stamp-progress" class="text-lg text-gray-700">0 / 0 個獲得</p>
                </div>
                 <div class="mt-6 text-center">
                    <img src="https://placehold.co/600x300/E0E7FF/4F46E5?text=スタンプラリーイメージ" alt="スタンプラリーのイメージ" class="rounded-lg shadow-md mx-auto w-full max-w-md h-auto">
                </div>
            </section>

            <!-- Stamp Collection Section -->
            <section id="collect-content" class="content-section">
                <h2 class="text-2xl font-semibold text-indigo-700 mb-6">スタンプを獲得する</h2>
                <div id="stamp-list-collect" class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <!-- スタンプカード（獲得用）がここに挿入されます -->
                </div>
            </section>

            <!-- Locations Section -->
            <section id="locations-content" class="content-section">
                <h2 class="text-2xl font-semibold text-indigo-700 mb-6">獲得可能な場所一覧</h2>
                <div id="stamp-locations-list" class="space-y-6">
                    <!-- スタンプ場所詳細がここに挿入されます -->
                </div>
            </section>
        </main>
    </div>

    <!-- モーダル -->
    <div id="info-modal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title" class="text-2xl font-semibold mb-4"></h3>
            <p id="modal-message" class="text-gray-700 mb-6"></p>
            <button id="modal-close-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-6 rounded-lg transition duration-150 ease-in-out">
                閉じる
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, writeBatch, Timestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-stamp-rally-app-v2'; // App IDを少し変更 (v2)

        let app;
        let auth;
        let db;
        let userId;
        let isAuthReady = false;
        let stampsData = [];
        let unsubscribeStamps = null;

        const initialStampPoints = [
            { id: "tokyo-station", name: "東京駅", description: "日本の玄関口", latitude: 35.681236, longitude: 139.767125, detailedDescription: "赤レンガ造りの丸の内駅舎は国の重要文化財。駅周辺には商業施設も多く、日本の交通網の中心の一つです。", mapLink: "https://www.google.com/maps?q=35.681236,139.767125", isCollected: false, collectedAt: null },
            { id: "shibuya-scramble", name: "渋谷スクランブル交差点", description: "世界最大級の交差点", latitude: 35.659520, longitude: 139.700433, detailedDescription: "1日に数十万人が行き交うと言われる渋谷の象徴。多くの映画やドラマの舞台にもなっています。周辺にはファッションビルや飲食店が立ち並びます。", mapLink: "https://www.google.com/maps?q=35.659520,139.700433", isCollected: false, collectedAt: null },
            { id: "senso-ji", name: "浅草寺", description: "雷門で有名な古刹", latitude: 35.714765, longitude: 139.796656, detailedDescription: "創建は628年と伝わる都内最古の寺院。雷門や五重塔、仲見世通りなど見どころが多く、国内外から多くの観光客が訪れます。", mapLink: "https://www.google.com/maps?q=35.714765,139.796656", isCollected: false, collectedAt: null },
            { id: "tokyo-tower", name: "東京タワー", description: "東京のシンボル", latitude: 35.658581, longitude: 139.745433, detailedDescription: "1958年に開業した高さ333mの電波塔。展望台からは東京の景色を一望でき、夜はライトアップも美しいです。", mapLink: "https://www.google.com/maps?q=35.658581,139.745433", isCollected: false, collectedAt: null },
            { id: "skytree", name: "東京スカイツリー", description: "世界一高い電波塔", latitude: 35.710063, longitude: 139.8107, detailedDescription: "高さ634mを誇る自立式電波塔。天望デッキや天望回廊からの眺めは圧巻。商業施設「東京ソラマチ」も併設されています。", mapLink: "https://www.google.com/maps?q=35.710063,139.8107", isCollected: false, collectedAt: null },
        ];
        const COLLECTION_NAME = 'stamps-v2'; // Collection名も変更

        // UI Elements
        const loadingIndicator = document.getElementById('loading-indicator');
        const authMessageElement = document.getElementById('auth-message');
        const appMainContent = document.getElementById('app-main-content');
        const userIdDisplay = document.getElementById('user-id-display');
        
        const homeContent = document.getElementById('home-content');
        const collectContent = document.getElementById('collect-content');
        const locationsContent = document.getElementById('locations-content');
        const contentSections = [homeContent, collectContent, locationsContent];

        const homeStampProgressElement = document.getElementById('home-stamp-progress');
        const stampListCollectElement = document.getElementById('stamp-list-collect');
        const stampLocationsListElement = document.getElementById('stamp-locations-list');

        const tabButtons = document.querySelectorAll('.tab-button');

        // Modal
        const modal = document.getElementById('info-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseButton = document.getElementById('modal-close-button');

        modalCloseButton.onclick = () => modal.style.display = "none";
        window.onclick = (event) => { if (event.target == modal) modal.style.display = "none"; };

        function showModal(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modal.style.display = "block";
        }

        // Tab Navigation Logic
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetTab = button.dataset.tab;
                activateTab(targetTab);
            });
        });

        function activateTab(tabName) {
            tabButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tabName);
            });
            contentSections.forEach(section => {
                section.classList.toggle('active', section.id.startsWith(tabName));
            });
        }
        
        // Distance Calculation
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }
        function deg2rad(deg) { return deg * (Math.PI / 180); }

        // Update UI for all sections based on stampsData
        function updateAllUI() {
            updateHomeUI();
            updateCollectUI();
            updateLocationsUI();
        }

        function updateHomeUI() {
            if (!homeStampProgressElement || !stampsData) return;
            const collectedCount = stampsData.filter(s => s.isCollected).length;
            homeStampProgressElement.textContent = `${collectedCount} / ${stampsData.length} 個獲得`;
        }

        function updateCollectUI() {
            if (!stampListCollectElement || !stampsData) return;
            stampListCollectElement.innerHTML = '';
            stampsData.forEach(stamp => {
                const card = document.createElement('div');
                card.className = `stamp p-5 rounded-lg shadow-md flex flex-col items-center justify-between ${stamp.isCollected ? 'stamp-collected' : 'stamp-not-collected'}`;
                
                const nameElement = document.createElement('h3');
                nameElement.className = 'text-lg font-semibold mb-1 text-center';
                nameElement.textContent = stamp.name;
                card.appendChild(nameElement);

                const descriptionElement = document.createElement('p');
                descriptionElement.className = `text-xs mb-3 text-center ${stamp.isCollected ? 'text-gray-100' : 'text-gray-600'}`;
                descriptionElement.textContent = stamp.description;
                card.appendChild(descriptionElement);

                if (stamp.isCollected) {
                    const collectedText = document.createElement('p');
                    collectedText.className = 'text-sm font-medium text-center';
                    collectedText.innerHTML = `獲得済み！<br><span class="text-xs">${stamp.collectedAt && stamp.collectedAt.seconds ? new Date(stamp.collectedAt.seconds * 1000).toLocaleDateString() : ''}</span>`;
                    card.appendChild(collectedText);
                    const stampIcon = document.createElement('div');
                    stampIcon.innerHTML = `<svg class="w-12 h-12 mx-auto mt-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.469 6.469a.75.75 0 00-1.06 0L8.75 13.844l-1.95-1.95a.75.75 0 10-1.06 1.06l2.5 2.5a.75.75 0 001.06 0l4.5-4.5a.75.75 0 000-1.06z" clip-rule="evenodd"></path></svg>`;
                    card.appendChild(stampIcon);
                } else {
                    const collectButton = document.createElement('button');
                    collectButton.textContent = 'スタンプ獲得チェック';
                    collectButton.className = 'mt-3 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-3 rounded-lg text-sm transition duration-150 ease-in-out w-full';
                    collectButton.onclick = () => tryCollectStamp(stamp);
                    card.appendChild(collectButton);
                }
                stampListCollectElement.appendChild(card);
            });
        }
        
        function updateLocationsUI() {
            if (!stampLocationsListElement || !stampsData) return;
            stampLocationsListElement.innerHTML = '';
            stampsData.forEach(stamp => {
                const locationDiv = document.createElement('div');
                locationDiv.className = `p-5 rounded-lg shadow-lg ${stamp.isCollected ? 'bg-emerald-50' : 'bg-white'}`;

                let statusText = stamp.isCollected ? 
                    `<span class="text-emerald-600 font-semibold">獲得済み</span> (${new Date(stamp.collectedAt.seconds * 1000).toLocaleDateString()})` : 
                    '<span class="text-red-600 font-semibold">未獲得</span>';

                locationDiv.innerHTML = `
                    <h3 class="text-xl font-semibold text-indigo-800 mb-2">${stamp.name}</h3>
                    <p class="text-sm text-gray-500 mb-1">状態: ${statusText}</p>
                    <p class="text-gray-700 mb-3 text-sm">${stamp.detailedDescription}</p>
                    <div class="flex items-center justify-start space-x-3">
                        <a href="${stamp.mapLink}" target="_blank" rel="noopener noreferrer" class="inline-block bg-blue-500 hover:bg-blue-600 text-white text-xs font-medium py-1.5 px-3 rounded-md transition duration-150">
                            地図で見る
                        </a>
                        ${!stamp.isCollected ? `<button data-stamp-id="${stamp.id}" class="quick-collect-btn inline-block bg-indigo-500 hover:bg-indigo-600 text-white text-xs font-medium py-1.5 px-3 rounded-md transition duration-150">ここで獲得チェック</button>` : ''}
                    </div>
                `;
                stampLocationsListElement.appendChild(locationDiv);
            });
            // Add event listeners for newly created "quick-collect-btn"
            document.querySelectorAll('.quick-collect-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const stampId = e.target.dataset.stampId;
                    const stampToCollect = stampsData.find(s => s.id === stampId);
                    if (stampToCollect) {
                        tryCollectStamp(stampToCollect);
                    }
                });
            });
        }


        // Try to collect stamp
        async function tryCollectStamp(stampToCollect) {
            showModal("処理中...", "現在位置を取得し、スタンプ獲得を試みています。");
            modalCloseButton.disabled = true;

            if (!navigator.geolocation) {
                showModal("エラー", "お使いのブラウザは位置情報サービスに対応していません。");
                modalCloseButton.disabled = false;
                return;
            }

            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
                });
                const { latitude: userLat, longitude: userLon } = position.coords;
                const distance = getDistance(userLat, userLon, stampToCollect.latitude, stampToCollect.longitude);
                const acquisitionRange = 0.5; // 500m

                if (distance <= acquisitionRange) {
                    const stampDocRef = doc(db, `artifacts/${appId}/users/${userId}/${COLLECTION_NAME}`, stampToCollect.id);
                    await setDoc(stampDocRef, { isCollected: true, collectedAt: Timestamp.now() }, { merge: true });
                    showModal("スタンプ獲得！", `${stampToCollect.name} のスタンプを獲得しました！`);
                } else {
                    showModal("残念！", `${stampToCollect.name} にはまだ距離があります。(約 ${distance.toFixed(2)} km)`);
                }
            } catch (error) {
                console.error("Error collecting stamp - Message:", error.message, "Code:", error.code, "Details:", error);
                let message = "スタンプ獲得処理中にエラーが発生しました。";
                if (error.code === 1) message = "位置情報の取得が許可されませんでした。";
                else if (error.code === 2) message = "位置情報が取得できませんでした（電波状況など）。";
                else if (error.code === 3) message = "位置情報の取得がタイムアウトしました。";
                showModal("エラー", message);
            } finally {
                modalCloseButton.disabled = false;
            }
        }

        // Load or initialize stamps from Firestore
        async function loadOrInitializeStamps() {
            if (!db || !userId) return;
            const collectionPath = `artifacts/${appId}/users/${userId}/${COLLECTION_NAME}`;
            const stampsCollectionRef = collection(db, collectionPath);

            if (unsubscribeStamps) unsubscribeStamps();
            
            unsubscribeStamps = onSnapshot(stampsCollectionRef, (snapshot) => {
                loadingIndicator.style.display = 'none'; // Hide loading indicator once data (or empty) is fetched
                appMainContent.style.display = 'block'; // Show main content area

                if (snapshot.empty) {
                    console.log("No stamps found for user, initializing...");
                    const batch = writeBatch(db);
                    initialStampPoints.forEach(stamp => {
                        const stampDocRef = doc(db, collectionPath, stamp.id);
                        batch.set(stampDocRef, { ...stamp, isCollected: false, collectedAt: null });
                    });
                    batch.commit()
                        .then(() => console.log("Initial stamps successfully written."))
                        .catch(err => {
                            console.error("Error writing initial stamps: ", err);
                            showModal("初期化エラー", "スタンプデータの初期化に失敗しました。");
                        });
                    stampsData = initialStampPoints.map(s => ({...s, isCollected: false, collectedAt: null}));
                } else {
                    const fetchedStamps = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    stampsData = initialStampPoints.map(initial => {
                        const fetched = fetchedStamps.find(fs => fs.id === initial.id);
                        return fetched ? { ...initial, ...fetched } : { ...initial, isCollected: false, collectedAt: null };
                    });
                }
                updateAllUI(); // Update all relevant UI parts
                activateTab('home'); // Activate home tab by default after data load

            }, (error) => {
                console.error("Error fetching stamps from Firestore: ", error);
                showModal("データ取得エラー", "スタンプ情報の取得に失敗しました。");
                loadingIndicator.style.display = 'none';
                authMessageElement.textContent = "スタンプデータの読み込みに失敗しました。";
                authMessageElement.style.display = 'block';
                appMainContent.style.display = 'none';
            });
        }
        
        // Initialize App Logic
        async function initializeAppLogic() {
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config is empty.");
                loadingIndicator.style.display = 'none';
                authMessageElement.textContent = "Firebaseの設定が読み込まれていません。";
                authMessageElement.style.display = 'block';
                appMainContent.style.display = 'none';
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('debug');
                await setPersistence(auth, browserLocalPersistence);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        console.log("User signed in. UID:", userId);
                        userIdDisplay.textContent = `ユーザーID: ${userId}`;
                        authMessageElement.style.display = 'none';
                        appMainContent.style.display = 'block'; // Show content area once auth is ready
                        await loadOrInitializeStamps();
                    } else {
                        console.log("User not signed in. Attempting sign-in.");
                        userIdDisplay.textContent = "ユーザー認証中...";
                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Sign-in failed:", error);
                            isAuthReady = false; userId = null;
                            loadingIndicator.style.display = 'none';
                            authMessageElement.textContent = "認証に失敗しました。アプリを利用できません。";
                            authMessageElement.style.display = 'block';
                            appMainContent.style.display = 'none';
                            userIdDisplay.textContent = "認証エラー";
                        }
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase: ", error);
                loadingIndicator.style.display = 'none';
                authMessageElement.textContent = "Firebaseの初期化に失敗しました。";
                authMessageElement.style.display = 'block';
                appMainContent.style.display = 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            appMainContent.style.display = 'none'; // Hide main content until auth and data are ready
            initializeAppLogic();
        });
    </script>
</body>
</html>
